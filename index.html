<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Physics Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --bg-color: #f8fafc; /* Slate 50 */
            --panel-bg: #ffffff;
            --text-primary: #0f172a; /* Slate 900 */
            --text-secondary: #64748b; /* Slate 500 */
            --border-color: #e2e8f0; /* Slate 200 */
            --accent-color: #2563eb; /* Blue 600 */
            --control-bg: #f1f5f9; /* Slate 100 */
            --control-text: #0f172a;
        }

        html.dark {
            --bg-color: #0f172a; /* Slate 900 */
            --panel-bg: #1e293b; /* Slate 800 */
            --text-primary: #f1f5f9; /* Slate 100 */
            --text-secondary: #94a3b8; /* Slate 400 */
            --border-color: #334155; /* Slate 700 */
            --control-bg: #334155; /* Slate 700 */
            --control-text: #f1f5f9;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--border-color) 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .app-view { display: none; }
        .app-view.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px) scale(0.99); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(-15px) scale(0.99); }
        }
        .view-enter { animation: fadeIn 0.4s cubic-bezier(0.215, 0.610, 0.355, 1.000) forwards; }
        .view-exit { animation: fadeOut 0.3s cubic-bezier(0.550, 0.055, 0.675, 0.190) forwards; }
        
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(100%); }
            to { opacity: 1; transform: translateY(0); }
        }
        .notification {
            animation: slideInUp 0.5s cubic-bezier(0.215, 0.610, 0.355, 1.000) forwards;
        }

        .bg-panel { background-color: var(--panel-bg); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .border-main { border-color: var(--border-color); }
        .bg-control { background-color: var(--control-bg); }
        .text-control { color: var(--control-text); }


        .experiment-card, .plan-card, .stat-card {
            background-color: var(--panel-bg);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            border: 1px solid var(--border-color);
        }
        .experiment-card:hover, .plan-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px -5px rgba(15, 23, 42, 0.07);
        }
        html.dark .experiment-card:hover, html.dark .plan-card:hover {
             box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.2);
        }
        .experiment-card.disabled { cursor: not-allowed; opacity: 0.6; }
        .experiment-card.disabled:hover { transform: none; box-shadow: none; }
        
        .hint-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        .hint-toggle i { transition: transform 0.3s ease; }

        .canvas-container { position: relative; width: 100%; max-width: 500px; touch-action: none; }
        .crosshair {
            position: absolute; top: 50%; left: 0; width: 100%; height: 1px;
            background: rgba(239, 68, 68, 0.8); cursor: ns-resize;
        }
        .crosshair::before {
            content: ''; position: absolute; background: rgba(239, 68, 68, 0.8);
            left: 50%; top: -249.5px; width: 1px; height: 500px;
        }
        input, select {
            background-color: var(--control-bg);
            color: var(--control-text);
            border: 1px solid var(--border-color);
        }
        input[type="range"] { -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer;width:100%; border: none;}
        input[type="range"]::-webkit-slider-runnable-track { background: var(--border-color); height: 0.25rem; border-radius: 0.25rem; }
        input[type="range"]::-moz-range-track { background: var(--border-color); height: 0.25rem; border-radius: 0.25rem; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -0.375rem; background-color: var(--accent-color); height: 1rem; width: 1rem; border-radius: 9999px; border:2px solid var(--panel-bg); box-shadow: 0 0 0 1px rgba(0,0,0,0.1); }
        input[type="range"]::-moz-range-thumb { border: none; border-radius: 9999px; background-color: var(--accent-color); height: 1rem; width: 1rem; }
    </style>
</head>
<body class="p-4">

    <div class="w-full max-w-7xl mx-auto min-h-screen">
        <!-- Main Menu View -->
        <div id="menu-view" class="app-view">
            <header class="text-center mb-10 relative">
                <div class="flex justify-center items-center gap-4 md:gap-8 mb-4">
                    <img src="https://github.com/Tech4Aditya/Virtual-Physics-Lab/blob/main/Logo-jiit%20(1).png?raw=true" alt="JIIT Logo" class="h-16 md:h-20">
                    <span class="text-4xl md:text-5xl font-light text-secondary">&times;</span>
                    <img src="https://github.com/Tech4Aditya/Virtual-Physics-Lab/blob/main/adityapandey.jpg?raw=true" alt="Aditya Pandey Logo" class="h-16 w-16 md:h-20 md:w-20 rounded-full object-cover border-2 border-main">
                </div>
                <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-primary">Virtual Physics Lab</h1>
                <p class="text-lg text-secondary mt-2">A JIIT & Aditya Pandey Collaboration</p>
                 <div class="absolute top-0 right-0 flex items-center gap-2">
                    <button id="go-premium-btn" class="text-sm font-semibold bg-amber-400 text-amber-900 px-3 py-2 rounded-lg hover:bg-amber-500 transition-colors">
                        Go Premium
                    </button>
                    <button id="theme-toggle-btn" class="p-2 rounded-full bg-control hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                        <i id="theme-icon" class="ph ph-moon text-2xl text-primary"></i>
                    </button>
                 </div>
            </header>
            <main id="main-menu-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Experiment cards are injected by JavaScript -->
            </main>
             <footer class="text-center mt-12 text-secondary text-sm">
                Made by Aditya Pandey
            </footer>
        </div>

        <!-- VIEWS FOR EACH EXPERIMENT (Injected by JS) -->
        <div id="newtons-rings-view" class="app-view"></div>
        <div id="fresnels-biprism-view" class="app-view"></div>
        <div id="polarimeter-view" class="app-view"></div>
        <div id="stefans-law-view" class="app-view"></div>
        <div id="carey-foster-bridge-view" class="app-view"></div>
        <div id="subscription-view" class="app-view"></div>
    </div>

    <!-- Notification Panel -->
    <div id="notification-panel" class="notification fixed bottom-4 right-4 w-full max-w-sm bg-panel shadow-2xl rounded-lg p-4 border border-main hidden">
        <div class="flex items-start gap-4">
            <div class="text-blue-500 mt-1">
                <i class="ph-fill ph-info text-2xl"></i>
            </div>
            <div>
                <h4 class="font-bold text-primary">Feedback & Suggestions</h4>
                <p class="text-sm text-secondary mt-1">Please contact Aditya Pandey for any feedback and suggestions to improve this lab.</p>
            </div>
            <button id="close-notification-btn" class="ml-auto text-secondary hover:text-primary">&times;</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- NOTIFICATION LOGIC ---
            const notificationPanel = document.getElementById('notification-panel');
            const closeNotificationBtn = document.getElementById('close-notification-btn');
            setTimeout(() => {
                notificationPanel.classList.remove('hidden');
            }, 2000); 
            closeNotificationBtn.addEventListener('click', () => {
                notificationPanel.style.display = 'none';
            });


            // --- THEME SWITCHER LOGIC ---
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const themeIcon = document.getElementById('theme-icon');
            const htmlEl = document.documentElement;

            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    htmlEl.classList.add('dark');
                    themeIcon.classList.remove('ph-moon');
                    themeIcon.classList.add('ph-sun');
                } else {
                    htmlEl.classList.remove('dark');
                    themeIcon.classList.remove('ph-sun');
                    themeIcon.classList.add('ph-moon');
                }
            };
            
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);

            themeToggleBtn.addEventListener('click', () => {
                const newTheme = htmlEl.classList.contains('dark') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });


            // --- CORE APP LOGIC (SINGLE-PAGE APPLICATION FRAMEWORK) ---
            const App = {
                views: {},
                currentView: 'menu-view',

                init() {
                    document.querySelectorAll('.app-view').forEach(v => { this.views[v.id] = v; });
                    this.views[this.currentView].classList.add('active');
                    this.createMainMenu();
                    this.setupEventListeners();
                },

                showView(viewId) {
                    if (this.currentView === viewId) return;

                    const oldView = this.views[this.currentView];
                    if (oldView) {
                        oldView.classList.add('view-exit');
                        oldView.addEventListener('animationend', () => { oldView.classList.remove('active', 'view-exit'); }, { once: true });
                    }
                    
                    const newView = this.views[viewId];
                    if (newView) {
                        if (!newView.innerHTML.trim() && templates[viewId.replace('-view', '')]) {
                             newView.innerHTML = templates[viewId.replace('-view', '')];
                        }

                        newView.classList.add('active', 'view-enter');
                        newView.addEventListener('animationend', () => { newView.classList.remove('view-enter'); }, { once: true });
                    }
                    this.currentView = viewId;
                    window.scrollTo(0, 0);
                },

                createMainMenu() {
                    const menuGrid = document.getElementById('main-menu-grid');
                    const experiments = [
                        { id: 'newtons-rings', name: "Newton's Rings", desc: "Determine wavelength using interference rings.", icon: 'ph-atom', color: 'text-indigo-500' },
                        { id: 'fresnels-biprism', name: "Fresnel's Bi-Prism", desc: "Measure wavelength with division of wavefront.", icon: 'ph-wave-triangle', color: 'text-sky-500' },
                        { id: 'polarimeter', name: "Polarimeter", desc: "Find specific rotation of a sugar solution.", icon: 'ph-circles-three', color: 'text-emerald-500' },
                        { id: 'stefans-law', name: "Stefan's Law", desc: "Verify the T⁴ law of black-body radiation.", icon: 'ph-thermometer-hot', color: 'text-red-500' },
                        { id: 'carey-foster-bridge', name: "Carey Foster's Bridge", desc: "Measure resistance with a modified Wheatstone bridge.", icon: 'ph-plugs-connected', color: 'text-amber-500' },
                        { id: 'spectrometer', name: "Spectrometer", desc: "Under Construction", icon: 'ph-prism', color: 'text-purple-500', disabled: true },
                        { id: 'photo-electric-effect', name: "Photoelectric Effect", desc: "Under Construction", icon: 'ph-lightbulb', color: 'text-yellow-500', disabled: true },
                        { id: 'hall-effect', name: "Hall Effect", desc: "Under Construction", icon: 'ph-magnet', color: 'text-rose-500', disabled: true },
                    ];
                    menuGrid.innerHTML = experiments.map(exp => `
                        <div data-experiment="${exp.id}" class="experiment-card p-6 rounded-xl flex flex-col items-center text-center ${exp.disabled ? 'disabled' : 'cursor-pointer'}">
                            <i class="ph-fill ${exp.icon} text-5xl ${exp.color}"></i>
                            <h2 class="text-lg font-semibold mt-4 text-primary">${exp.name}</h2>
                            <p class="text-sm text-secondary mt-1">${exp.desc}</p>
                        </div>
                    `).join('');
                },

                setupEventListeners() {
                    document.body.addEventListener('click', (event) => {
                        const card = event.target.closest('.experiment-card');
                        if (card && !card.classList.contains('disabled')) {
                            const experimentId = card.dataset.experiment;
                            const viewId = `${experimentId}-view`;
                            
                            this.showView(viewId);
                            
                            const view = this.views[viewId];
                            if (view && !view.dataset.initialized) {
                                const initFuncName = `init${experimentId.charAt(0).toUpperCase() + experimentId.slice(1).replace(/-/g, '')}`;
                                if (typeof initFunctions[initFuncName] === 'function') {
                                    initFunctions[initFuncName](view);
                                }
                                view.dataset.initialized = 'true';
                            }
                        }

                        if (event.target.closest('#go-premium-btn')) this.showView('subscription-view');
                        if (event.target.closest('.back-to-menu-btn')) this.showView('menu-view');

                        const hintToggle = event.target.closest('.hint-toggle');
                        if (hintToggle) {
                            const content = hintToggle.nextElementSibling;
                            const icon = hintToggle.querySelector('i');
                            if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                                content.style.maxHeight = '0px';
                                icon.style.transform = 'rotate(0deg)';
                            } else {
                                content.style.maxHeight = content.scrollHeight + "px";
                                icon.style.transform = 'rotate(180deg)';
                            }
                        }
                    });
                }
            };

            const initFunctions = {};
            const templates = {};
            const sharedUtils = {
                wavelengthToHSL:(w)=>{let R,G,B;if(w>=380&&w<440){R=-(w-440)/(440-380);G=0;B=1}else if(w>=440&&w<490){R=0;G=(w-440)/(490-440);B=1}else if(w>=490&&w<510){R=0;G=1;B=-(w-510)/(510-490)}else if(w>=510&&w<580){R=(w-510)/(580-510);G=1;B=0}else if(w>=580&&w<645){R=1;G=-(w-645)/(645-580);B=0}else if(w>=645&&w<=780){R=1;G=0;B=0}else{R=0;G=0;B=0}let f=(c)=>{c=Math.max(0,Math.min(1,c));return c>0.04045?Math.pow((c+0.055)/1.055,2.4):c/12.92;},l=0.2126*f(R)+0.7152*f(G)+0.0722*f(B);let factor=Math.pow(l,0.4);return{r:R*factor*255,g:G*factor*255,b:B*factor*255}},
                makeDraggable: (el, onDrag, dir = 'y') => {
                    let isDragging = false;
                    const moveHandler = (e) => {
                        if (!isDragging) return;
                        const event = e.touches ? e.touches[0] : e;
                        const rect = el.closest('.canvas-container, .bridge-container').getBoundingClientRect();
                        let value;
                        if (dir === 'y') {
                            value = event.clientY - rect.top;
                        } else {
                            value = event.clientX - rect.left;
                        }
                        onDrag(Math.max(0, Math.min(dir === 'y' ? rect.height : rect.width, value)));
                    };
                    const endDrag = () => { isDragging = false; document.removeEventListener('mousemove', moveHandler); document.removeEventListener('touchmove', moveHandler); document.removeEventListener('mouseup', endDrag); document.removeEventListener('touchend', endDrag);};
                    const startDrag = (e) => { isDragging = true; e.preventDefault(); document.addEventListener('mousemove', moveHandler); document.addEventListener('touchmove', moveHandler); document.addEventListener('mouseup', endDrag); document.addEventListener('touchend', endDrag); };
                    el.addEventListener('mousedown', startDrag);
                    el.addEventListener('touchstart', startDrag);
                }
            };

            // --- TEMPLATES AND LOGIC FOR EACH EXPERIMENT ---

            // 1. Newton's Rings
            templates['newtons-rings'] = `
                <div class="bg-panel text-primary p-6 sm:p-8 rounded-2xl shadow-lg">
                    <header class="flex items-center justify-between pb-4 border-b border-main"><h1 class="text-2xl font-bold">Newton's Rings</h1><button class="back-to-menu-btn bg-control hover:bg-slate-200 dark:hover:bg-slate-600 text-control font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i class="ph-arrow-left"></i>Back</button></header>
                    <div class="flex flex-col xl:flex-row gap-8 mt-6">
                        <div class="w-full xl:w-[450px] flex-shrink-0">
                            <div class="border border-main rounded-lg mb-4"><button class="hint-toggle w-full p-3 font-bold flex justify-between items-center"><span>Procedure & Hints</span><i class="ph-caret-down"></i></button><div class="hint-content"><div class="p-3 border-t border-main text-sm text-secondary"><strong>1. Take Readings:</strong> Move the red crosshair with your mouse/finger. Place it tangentially on a dark ring (e.g., the 10th). Click "Record Diameter". Repeat for other rings (e.g., 8th, 6th...).<br><strong>2. Calculate:</strong> With at least two readings, click "Calculate λ". The formula D²(n+p) - D²(n) / 4pR is used, where (n+p) and n are the highest and lowest recorded ring numbers.</div></div></div>
                            <h3 class="font-bold text-secondary mb-2">Apparatus</h3><div class="p-4 bg-control rounded-lg mb-4 flex justify-center"><svg width="300" height="200" viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg" class="w-full h-auto max-h-48"><style>.txt{font-family:monospace;font-size:10px;fill:var(--text-primary);}.arr{marker-end:url(#arrowhead);}</style><defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#f59e0b"/></marker></defs><rect x="10" y="80" width="30" height="40" fill="#fef08a" stroke="#ca8a04"/><text x="25" y="105" class="txt" text-anchor="middle">S</text><path d="M45 90 L 125 90" stroke="#f59e0b" stroke-width="1.5" class="arr"/><path d="M45 110 L 125 110" stroke="#f59e0b" stroke-width="1.5" class="arr"/><rect x="125" y="65" width="10" height="70" transform="rotate(45 130 100)" fill="#a5f3fc" stroke="#0891b2" opacity="0.7"/><text x="145" y="80" class="txt">G</text><path d="M140 120 L 140 160" stroke="#f59e0b" stroke-width="1.5" class="arr" transform="rotate(90 140 120)"/><path d="M 110 180 Q 150 160 190 180" stroke="var(--text-primary)" stroke-width="1.5" fill="none"/><rect x="110" y="180" width="80" height="5" stroke="var(--text-primary)" stroke-width="1.5" fill="var(--border-color)"/><text x="150" y="155" class="txt" text-anchor="middle">L & P</text><path d="M150 160 L 150 40" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="3 3"/><rect x="140" y="10" width="20" height="30" fill="#94a3b8" stroke="var(--text-primary)"/><circle cx="150" cy="45" r="5" stroke="var(--text-primary)" fill="none"/><path d="M145 10 L 135 0 M155 10 L 165 0" stroke="var(--text-primary)" fill="none"/><text x="170" y="25" class="txt">Microscope</text></svg></div>
                            <h3 class="font-bold text-secondary mb-2">Measurements</h3>
                            <div class="h-48 overflow-y-auto border border-main rounded-lg bg-panel mb-4"><table class="w-full text-sm text-left"><thead class="bg-control sticky top-0"><tr class="text-secondary"><th class="p-2">Ring (n)</th><th class="p-2">Dₙ (μm)</th><th class="p-2">Dₙ² (mm²)</th><th class="p-2"></th></tr></thead><tbody id="newton-readings"></tbody></table></div>
                            <div class="flex gap-4"><button id="calculate-lambda-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Calculate λ</button><button id="clear-readings-btn" class="w-full bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Clear</button></div>
                            <div id="newton-result" class="mt-4 text-center font-semibold text-lg"></div>
                        </div>
                        <div class="flex-1 min-w-0"><div class="flex flex-col lg:flex-row gap-8"><div class="flex-1 flex flex-col items-center"><h3 class="font-bold text-secondary mb-2 text-center">Microscope View</h3><div class="canvas-container"><canvas id="newtonCanvas" width="500" height="500" class="rounded-full bg-black cursor-pointer"></canvas><div id="newtonCrosshair" class="crosshair"></div></div><div class="flex items-center gap-4 mt-4"><input id="ring-number-input" type="number" min="1" max="20" value="10" class="w-20 p-2 rounded-md text-center"><button id="record-newton-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Record Ring</button></div><p id="newton-diameter-display" class="mt-2 font-mono text-secondary"></p></div><div class="w-full lg:w-[300px] bg-control p-6 rounded-xl border border-main"><h3 class="font-bold text-primary mb-6">Parameters</h3><div class="mb-6"><label class="flex justify-between items-center text-sm font-medium text-secondary mb-2"><span>Wavelength (λ)</span><span id="wavelength-val" class="font-bold text-indigo-600 bg-indigo-100 dark:bg-indigo-900 dark:text-indigo-300 px-2 py-1 rounded">589 nm</span></label><input id="wavelength" type="range" min="400" max="700" value="589"></div><div class="mb-6"><label class="flex justify-between items-center text-sm font-medium text-secondary mb-2"><span>Lens Radius (R)</span><span id="radius-val" class="font-bold text-indigo-600 bg-indigo-100 dark:bg-indigo-900 dark:text-indigo-300 px-2 py-1 rounded">1.0 m</span></label><input id="radius" type="range" min="0.5" max="5" value="1.0" step="0.1"></div><div><label class="flex justify-between items-center text-sm font-medium text-secondary mb-2"><span>Refractive Index (μ)</span><span id="n-val" class="font-bold text-indigo-600 bg-indigo-100 dark:bg-indigo-900 dark:text-indigo-300 px-2 py-1 rounded">1.00</span></label><input id="refractiveIndex" type="range" min="1.00" max="2.00" value="1.00" step="0.01"></div></div></div></div>
                    </div>
                </div>`;
            initFunctions.initNewtonsrings = function(view) {
                const canvas=view.querySelector('#newtonCanvas'),ctx=canvas.getContext('2d'),wS=view.querySelector('#wavelength'),rS=view.querySelector('#radius'),nS=view.querySelector('#refractiveIndex'),wV=view.querySelector('#wavelength-val'),rV=view.querySelector('#radius-val'),nV=view.querySelector('#n-val'),cH=view.querySelector('#newtonCrosshair'),dD=view.querySelector('#newton-diameter-display'),recB=view.querySelector('#record-newton-btn'),rBody=view.querySelector('#newton-readings'),calcB=view.querySelector('#calculate-lambda-btn'),clrB=view.querySelector('#clear-readings-btn'),resD=view.querySelector('#newton-result'),ringNumInput=view.querySelector('#ring-number-input');
                const w=canvas.width,h=canvas.height,cX=w/2,cY=h/2,sc=25000;let readings=[];
                function draw(){const l=parseFloat(wS.value)*1e-9,R=parseFloat(rS.value),mu=parseFloat(nS.value);wV.textContent=`${wS.value} nm`;rV.textContent=`${R.toFixed(1)} m`;nV.textContent=mu.toFixed(2);const rgb=sharedUtils.wavelengthToHSL(parseFloat(wS.value));ctx.fillStyle='black';ctx.fillRect(0,0,w,h);for(let r_px=Math.min(cX,cY);r_px>=0;r_px--){const r_m=r_px/sc,t=(r_m*r_m)/(2*R),pD=(2*Math.PI/l)*(2*mu*t)+Math.PI,i=(1+Math.cos(pD))/2;ctx.beginPath();ctx.strokeStyle=`rgba(${rgb.r},${rgb.g},${rgb.b},${i})`;ctx.lineWidth=1.5;ctx.arc(cX,cY,r_px,0,2*Math.PI);ctx.stroke();}}
                function updateCH(y){const r_px=Math.abs(y-cY),d_um=(2*r_px/sc)*1e6;cH.style.top=`${y}px`;dD.textContent=`Diameter = ${d_um.toFixed(0)} µm`;}
                function deleteReading(n){readings=readings.filter(r=>r.n!==n);updateTable();}
                function updateTable(){readings.sort((a,b)=>b.n-a.n);rBody.innerHTML=readings.map(r=>`<tr><td class="p-2 font-mono">${r.n}</td><td class="p-2 font-mono">${(Math.sqrt(r.d_sq)*1000).toFixed(0)}</td><td class="p-2 font-mono">${r.d_sq.toFixed(4)}</td><td class="p-2"><button data-n="${r.n}" class="delete-reading-btn text-red-500 hover:text-red-700 font-bold text-lg leading-none">&times;</button></td></tr>`).join('');calcB.disabled=readings.length<2;const deleteBtns=rBody.querySelectorAll('.delete-reading-btn');deleteBtns.forEach(btn=>btn.addEventListener('click',()=>deleteReading(parseInt(btn.dataset.n))));}
                recB.addEventListener('click',()=>{const n=parseInt(ringNumInput.value);if(!n||n<1||readings.find(r=>r.n===n)){return;}const tS=cH.style.top||`${cY}px`,r_px=Math.abs(parseFloat(tS)-cY),d_m=(2*r_px/sc),d_sq_mm=(d_m*1e3)**2;readings.push({n,d_sq:d_sq_mm});updateTable();});
                clrB.addEventListener('click',()=>{readings=[];updateTable();resD.innerHTML='';});
                calcB.addEventListener('click',()=>{if(readings.length<2){resD.innerHTML=`<span class="text-red-500">Need at least 2 readings.</span>`;return;}const last=readings[0],first=readings[readings.length-1],p=last.n-first.n;if(p<=0){resD.innerHTML=`<span class="text-red-500">Invalid ring selection for calculation.</span>`;return;}const d_diff_sq_m=(last.d_sq-first.d_sq)/1e6,R=parseFloat(rS.value),cL=d_diff_sq_m/(4*p*R),cL_nm=cL*1e9;resD.innerHTML=`Calculated λ: <span class="text-blue-600">${cL_nm.toFixed(1)} nm</span>`;});
                [wS,rS,nS].forEach(s=>s.addEventListener('input',draw));sharedUtils.makeDraggable(cH,updateCH,'y');draw();updateCH(cY);
            };

            // 2. Fresnel's Biprism
            templates['fresnels-biprism'] = `
                <div class="bg-panel text-primary p-6 sm:p-8 rounded-2xl shadow-lg">
                    <header class="flex items-center justify-between pb-4 border-b border-main"><h1 class="text-2xl font-bold">Fresnel's Bi-Prism</h1><button class="back-to-menu-btn bg-control hover:bg-slate-200 dark:hover:bg-slate-600 text-control font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i class="ph-arrow-left"></i>Back</button></header>
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mt-6">
                        <div class="flex flex-col items-center">
                            <h3 id="biprism-view-title" class="font-bold text-secondary mb-2 text-center">Fringe View (Measure β)</h3>
                            <div class="canvas-container"><canvas id="biprismCanvas" width="500" height="500" class="bg-black cursor-pointer rounded-lg"></canvas><div id="biprismCrosshair" class="crosshair" style="top:50%;left:50%;height:500px;width:1px;background:rgba(239, 68, 68, 0.8);cursor:ew-resize;"><div style="content:'';position:absolute;background:rgba(239,68,68,0.8);left:-249.5px;top:50%;width:500px;height:1px;"></div></div></div>
                            <p id="biprism-micrometer-display" class="mt-2 font-mono text-secondary">Position = 2.500 mm</p>
                        </div>
                        <div>
                            <div class="border border-main rounded-lg mb-4"><button class="hint-toggle w-full p-3 font-bold flex justify-between items-center"><span>Procedure & Hints</span><i class="ph-caret-down"></i></button><div class="hint-content"><div class="p-3 border-t border-main text-sm text-secondary"><strong>1. Measure β:</strong> In "Fringe View", move the crosshair over several bright fringes and record their positions. Calculate the fringe width (β = Total Distance / No. of Fringes).<br><strong>2. Measure d:</strong> Switch to "Lens View". Two sets of images (d₁ and d₂) for the virtual sources will be shown. Measure their separations.<br><strong>3. Calculate λ:</strong> Use the formula λ = (β * √d₁d₂) / D.</div></div></div>
                            <div class="bg-control p-4 rounded-xl border border-main mb-4">
                                <h3 class="font-bold text-primary mb-4">Parameters</h3>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div><label class="font-medium text-secondary mb-1 block">Wavelength (λ nm)</label><input id="biprism-lambda" type="number" value="589" class="w-full p-2 rounded-md"></div>
                                    <div><label class="font-medium text-secondary mb-1 block">Slit-Screen (D cm)</label><input id="biprism-D" type="number" value="100" class="w-full p-2 rounded-md"></div>
                                    <div><label class="font-medium text-secondary mb-1 block">Source Sep. (d mm)</label><input id="biprism-d" type="number" value="0.5" step="0.01" class="w-full p-2 rounded-md"></div>
                                    <div><label class="font-medium text-secondary mb-1 block">Focal Length (f cm)</label><input id="biprism-f" type="number" value="20" class="w-full p-2 rounded-md"></div>
                                </div>
                            </div>
                            <div class="flex gap-4 mb-4"><button id="biprism-mode-btn" class="flex-1 bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Switch to Lens View</button><button id="biprism-record-btn" class="flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Record Position</button></div>
                            <div class="h-32 overflow-y-auto border border-main rounded-lg bg-panel mb-4"><table class="w-full text-sm text-left"><thead class="bg-control sticky top-0"><tr class="text-secondary"><th class="p-2">Measurement</th><th class="p-2">Value (mm)</th></tr></thead><tbody id="biprism-readings"></tbody></table></div>
                            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-200 dark:border-blue-800">
                               <h3 class="font-bold text-primary mb-2">Calculations</h3>
                               <div class="grid grid-cols-3 gap-2 text-sm items-center">
                                 <span class="text-secondary">Fringe Width β (mm)</span> <input id="biprism-beta-in" placeholder="e.g., 0.589" class="col-span-2 p-1 rounded-md">
                                 <span class="text-secondary">d = √d₁d₂ (mm)</span> <input id="biprism-d-in" placeholder="e.g., 0.5" class="col-span-2 p-1 rounded-md">
                               </div>
                               <button id="biprism-calculate-btn" class="w-full mt-3 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Calculate λ</button>
                               <p id="biprism-result" class="mt-2 text-center font-semibold text-lg"></p>
                            </div>
                        </div>
                    </div>
                </div>`;
            initFunctions.initFresnelsbiprism = function(view) {
                const canvas=view.querySelector('#biprismCanvas'),ctx=canvas.getContext('2d'),crosshair=view.querySelector('#biprismCrosshair'),display=view.querySelector('#biprism-micrometer-display'),title=view.querySelector('#biprism-view-title'),lambdaIn=view.querySelector('#biprism-lambda'),DIn=view.querySelector('#biprism-D'),dIn=view.querySelector('#biprism-d'),fIn=view.querySelector('#biprism-f'),modeBtn=view.querySelector('#biprism-mode-btn'),recordBtn=view.querySelector('#biprism-record-btn'),readingsBody=view.querySelector('#biprism-readings'),betaIn=view.querySelector('#biprism-beta-in'),dCalcIn=view.querySelector('#biprism-d-in'),calcBtn=view.querySelector('#biprism-calculate-btn'),result=view.querySelector('#biprism-result');
                const w=canvas.width,h=canvas.height,cX=w/2;let mode='fringes',readings=[];
                function draw(){
                    ctx.fillStyle='black'; ctx.fillRect(0,0,w,h);
                    const lambda = parseFloat(lambdaIn.value) * 1e-9;
                    const D = parseFloat(DIn.value) * 1e-2;
                    const d = parseFloat(dIn.value) * 1e-3;
                    const f = parseFloat(fIn.value) * 1e-2;
                    const rgb = sharedUtils.wavelengthToHSL(parseFloat(lambdaIn.value));

                    if (mode === 'fringes') {
                        const beta = (lambda * D) / d;
                        const beta_px = beta * 200000;
                        for (let x_px = 0; x_px < w; x_px++) {
                            const intensity = Math.cos(Math.PI * (x_px - cX) / beta_px)**2;
                            ctx.strokeStyle = `rgba(${rgb.r},${rgb.g},${rgb.b},${intensity})`;
                            ctx.beginPath(); ctx.moveTo(x_px, 0); ctx.lineTo(x_px, h); ctx.stroke();
                        }
                    } else { // Lens mode
                        if (D <= 4 * f) {
                            ctx.fillStyle = 'white'; ctx.font = '16px Inter'; ctx.textAlign = 'center';
                            ctx.fillText('D must be > 4f to get two images.', w/2, h/2); return;
                        }
                        const u1 = (D/2) + Math.sqrt((D/2)**2 - D*f); const v1 = D - u1; const m1 = v1 / u1; const d1 = m1 * d; const d1_px = d1 * 200000;
                        const u2 = (D/2) - Math.sqrt((D/2)**2 - D*f); const v2 = D - u2; const m2 = v2 / u2; const d2 = m2 * d; const d2_px = d2 * 200000;
                        ctx.fillStyle=`rgba(${rgb.r},${rgb.g},${rgb.b},0.8)`;
                        ctx.fillRect(cX-d1_px/2-2, h/4-25, 4, 50); ctx.fillRect(cX+d1_px/2-2, h/4-25, 4, 50);
                        ctx.strokeStyle='white'; ctx.setLineDash([5, 5]); ctx.beginPath(); ctx.moveTo(cX-d1_px/2, h/4+35); ctx.lineTo(cX+d1_px/2, h/4+35); ctx.stroke();
                        ctx.fillStyle='white'; ctx.font='14px Inter'; ctx.fillText(`d₁ = ${(d1*1000).toFixed(3)} mm`, cX, h/4+50);
                        ctx.fillStyle=`rgba(${rgb.r},${rgb.g},${rgb.b},0.8)`;
                        ctx.fillRect(cX-d2_px/2-2, 3*h/4-25, 4, 50); ctx.fillRect(cX+d2_px/2-2, 3*h/4-25, 4, 50);
                        ctx.setLineDash([5, 5]); ctx.beginPath(); ctx.moveTo(cX-d2_px/2, 3*h/4+35); ctx.lineTo(cX+d2_px/2, 3*h/4+35); ctx.stroke();
                        ctx.fillText(`d₂ = ${(d2*1000).toFixed(3)} mm`, cX, 3*h/4+50);
                        ctx.setLineDash([]);
                    }
                }
                function updateCH(x){const pos_mm = (x/w)*5; crosshair.style.left=`${x}px`; display.textContent=`Position = ${pos_mm.toFixed(3)} mm`;}
                [lambdaIn, DIn, dIn, fIn].forEach(el=>el.addEventListener('input', draw));
                modeBtn.addEventListener('click', ()=>{mode=mode==='fringes'?'lens':'fringes';modeBtn.textContent=mode==='fringes'?'Switch to Lens View':'Switch to Fringe View';title.textContent=mode==='fringes'?'Fringe View (Measure β)':'Lens View (Measure d₁ & d₂)';recordBtn.textContent=mode==='fringes'?'Record Position':'Record Separation';draw();});
                recordBtn.addEventListener('click',()=>{const pos_px=parseFloat(crosshair.style.left||`${cX}px`),val=(pos_px/w)*5;const type=mode==='fringes'?'Position':(readings.filter(r=>r.type.startsWith('Separation')).length===0?'Separation d₁':'Separation d₂');readings.push({type,val:val.toFixed(3)});readingsBody.innerHTML+=`<tr><td class="p-2">${type}</td><td class="p-2 font-mono">${val.toFixed(3)}</td></tr>`;});
                calcBtn.addEventListener('click',()=>{const beta=parseFloat(betaIn.value);const d_calc=parseFloat(dCalcIn.value);const D=parseFloat(DIn.value)*10;if(!beta||!d_calc||!D){result.textContent='Please input values.';return;}const lambda_nm=(beta*d_calc)/D;result.textContent=`Calculated λ: ${lambda_nm.toFixed(1)} nm`;});
                sharedUtils.makeDraggable(crosshair,updateCH,'x');draw();updateCH(cX);
            };

             // 3. Polarimeter
            templates['polarimeter'] = `
                <div class="bg-panel text-primary p-6 sm:p-8 rounded-2xl shadow-lg">
                    <header class="flex items-center justify-between pb-4 border-b border-main"><h1 class="text-2xl font-bold">Polarimeter</h1><button class="back-to-menu-btn bg-control hover:bg-slate-200 dark:hover:bg-slate-600 text-control font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i class="ph-arrow-left"></i>Back</button></header>
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mt-6">
                        <div class="flex flex-col items-center">
                            <h3 class="font-bold text-secondary mb-2 text-center">Eyepiece View</h3>
                            <div class="canvas-container"><canvas id="polarimeterCanvas" width="300" height="300" class="rounded-full bg-gray-800 border-8 border-gray-700 dark:border-slate-900"></canvas></div>
                            <div class="w-full max-w-sm mt-4">
                                <label class="flex justify-between items-center text-lg font-medium text-secondary mb-2">
                                    <span>Analyzer Angle (θ)</span><span id="angle-display" class="font-bold text-indigo-600 bg-indigo-100 dark:bg-indigo-900 dark:text-indigo-300 px-2 py-1 rounded">0.0°</span>
                                </label>
                                <input id="analyzer-angle" type="range" min="-45" max="45" value="0" step="0.1">
                            </div>
                        </div>
                        <div>
                            <div class="border border-main rounded-lg mb-4"><button class="hint-toggle w-full p-3 font-bold flex justify-between items-center"><span>Procedure & Hints</span><i class="ph-caret-down"></i></button><div class="hint-content"><div class="p-3 border-t border-main text-sm text-secondary"><strong>1. Set Concentration:</strong> Use the slider to prepare a sugar solution.<br><strong>2. Find Null Point:</strong> Adjust the "Analyzer Angle" slider until the two halves of the circle in the eyepiece match in color (a uniform grayish tint).<br><strong>3. Record & Repeat:</strong> Click "Record Angle" and repeat for different concentrations.<br><strong>4. Calculate S:</strong> Use the formula S = θ / (l * c) with your recorded data. The tube length (l) is fixed at 2 dm.</div></div></div>
                             <div class="bg-control p-4 rounded-xl border border-main mb-4">
                                <h3 class="font-bold text-primary mb-4">Solution Preparation</h3>
                                <label class="flex justify-between items-center text-sm font-medium text-secondary mb-2">
                                    <span>Concentration (c)</span><span id="concentration-val" class="font-bold text-emerald-600 bg-emerald-100 dark:bg-emerald-900 dark:text-emerald-300 px-2 py-1 rounded">0.10 g/mL</span>
                                </label>
                                <input id="concentration-slider" type="range" min="0" max="0.5" value="0.1" step="0.01">
                            </div>
                            <button id="polarimeter-record-btn" class="w-full mb-4 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Record Angle</button>
                            <div class="h-40 overflow-y-auto border border-main rounded-lg bg-panel mb-4"><table class="w-full text-sm text-left"><thead class="bg-control sticky top-0"><tr class="text-secondary"><th class="p-2">c (g/mL)</th><th class="p-2">θ (degrees)</th><th class="p-2">S (calc.)</th></tr></thead><tbody id="polarimeter-readings"></tbody></table></div>
                            <p class="text-center font-semibold text-lg" id="polarimeter-result"></p>
                        </div>
                    </div>
                </div>`;
            initFunctions.initPolarimeter = function(view) {
                const canvas=view.querySelector('#polarimeterCanvas'),ctx=canvas.getContext('2d'),angleSlider=view.querySelector('#analyzer-angle'),angleDisplay=view.querySelector('#angle-display'),concSlider=view.querySelector('#concentration-slider'),concVal=view.querySelector('#concentration-val'),recordBtn=view.querySelector('#polarimeter-record-btn'),readingsBody=view.querySelector('#polarimeter-readings'),resultDisplay=view.querySelector('#polarimeter-result');
                const w=canvas.width,h=canvas.height,cX=w/2,cY=h/2,r=w/2-10,L=2,S=66.5;
                let readings=[];
                function draw(){
                    const c=parseFloat(concSlider.value),userAngle=parseFloat(angleSlider.value),trueAngle=S*L*c,angleDiff=userAngle-trueAngle;
                    concVal.textContent=`${c.toFixed(2)} g/mL`; angleDisplay.textContent=`${userAngle.toFixed(1)}°`;
                    const tint=(val)=>Math.min(255,Math.max(0,val)),luma=100-Math.abs(angleDiff)*3,chroma=Math.abs(angleDiff)*5;
                    const left_r=tint(luma+chroma*Math.sign(angleDiff)),left_b=tint(luma-chroma*Math.sign(angleDiff)),right_r=tint(luma-chroma*Math.sign(angleDiff)),right_b=tint(luma+chroma*Math.sign(angleDiff));
                    ctx.clearRect(0,0,w,h);
                    ctx.beginPath(); ctx.moveTo(cX,cY-r); ctx.arc(cX,cY,r,-Math.PI/2,Math.PI/2); ctx.closePath(); ctx.fillStyle=`rgb(${left_r}, ${luma}, ${left_b})`; ctx.fill();
                    ctx.beginPath(); ctx.moveTo(cX,cY-r); ctx.arc(cX,cY,r,-Math.PI/2,Math.PI/2,true); ctx.closePath(); ctx.fillStyle=`rgb(${right_r}, ${luma}, ${right_b})`; ctx.fill();
                }
                function updateTable(){
                    let totalS=0;
                    readingsBody.innerHTML=readings.map(r=>{const s_calc=(r.theta/(L*r.c)).toFixed(1);totalS+=parseFloat(s_calc);return `<tr><td class="p-2 font-mono">${r.c.toFixed(2)}</td><td class="p-2 font-mono">${r.theta.toFixed(1)}</td><td class="p-2 font-mono">${s_calc}</td></tr>`}).join('');
                    if(readings.length>0){const meanS=(totalS/readings.length).toFixed(1);resultDisplay.innerHTML=`Mean Specific Rotation: <span class="text-emerald-600">${meanS}°/dm/g/mL</span>`;}else{resultDisplay.innerHTML='';}
                }
                recordBtn.addEventListener('click',()=>{const c=parseFloat(concSlider.value);const theta=parseFloat(angleSlider.value);if(c>0){readings.push({c,theta});updateTable();}});
                [angleSlider, concSlider].forEach(el=>el.addEventListener('input', draw));
                draw();
            };

            // 4. Stefan's Law
            templates['stefans-law'] = `
                <div class="bg-panel text-primary p-6 sm:p-8 rounded-2xl shadow-lg">
                    <header class="flex items-center justify-between pb-4 border-b border-main"><h1 class="text-2xl font-bold">Stefan's Law</h1><button class="back-to-menu-btn bg-control hover:bg-slate-200 dark:hover:bg-slate-600 text-control font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i class="ph-arrow-left"></i>Back</button></header>
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mt-6">
                        <div class="flex flex-col items-center">
                            <h3 class="font-bold text-secondary mb-2 text-center">Circuit Control</h3>
                            <div class="p-4 bg-control rounded-lg mb-4 w-full flex justify-center"><svg viewBox="0 0 400 200" class="w-full h-auto max-h-52"><path d="M50 150 V 50 H 350 V 150 H 50 Z" stroke="var(--text-primary)" fill="none" stroke-width="2"></path><path d="M50 100 h-20 M30 85 v 30 M20 92 v 16" stroke="var(--text-primary)" stroke-width="2"></path><text x="15" y="80" font-size="12" fill="var(--text-primary)">+</text><text x="15" y="125" font-size="16" fill="var(--text-primary)">-</text><text x="30" y="65" font-size="12" fill="var(--text-secondary)">6V</text><rect x="100" y="40" width="100" height="20" stroke="var(--text-primary)" fill="none" stroke-width="2"></rect><path d="M150 60 v 20 l -15 -15 h 30 z" stroke="var(--text-primary)" fill="var(--text-primary)" stroke-width="1"></path><path d="M150 80 V 150 H 100" stroke="var(--text-primary)" fill="none" stroke-width="2"></path><circle cx="250" cy="50" r="15" stroke="var(--text-primary)" fill="var(--panel-bg)" stroke-width="2"></circle><text x="247" y="55" font-family="monospace" font-size="14" fill="var(--text-primary)">A</text><circle id="stefan-bulb-outline" cx="350" cy="100" r="15" stroke="var(--text-primary)" fill="none" stroke-width="2"></circle><path d="M342 92 l 16 16 M342 108 l 16 -16" stroke="var(--text-primary)" stroke-width="2"></path><path d="M300 150 v -40" stroke="var(--text-primary)" fill="none" stroke-width="2"></path><path d="M350 115 h 20 v -30 h-20" stroke="var(--text-primary)" fill="none" stroke-width="2"></path><path d="M300 50 v 40" stroke="var(--text-primary)" fill="none" stroke-width="2"></path><circle cx="325" cy="100" r="15" stroke="var(--text-primary)" fill="var(--panel-bg)" stroke-width="2"></circle><text x="322" y="105" font-family="monospace" font-size="14" fill="var(--text-primary)">V</text></svg></div>
                             <div class="w-full max-w-sm mt-4">
                                <label class="flex justify-between items-center text-sm font-medium text-secondary mb-2"><span>Rheostat Control</span><span id="power-display" class="font-bold text-red-600 bg-red-100 dark:bg-red-900 dark:text-red-300 px-2 py-1 rounded">0.00 W</span></label>
                                <input id="rheostat-slider" type="range" min="0" max="100" value="0" step="1">
                                <div class="flex justify-between mt-2 text-sm font-mono text-secondary"><span>Min Power</span><span>Max Power</span></div>
                            </div>
                            <div class="mt-4 flex gap-8 text-center bg-control p-4 rounded-lg">
                                <div><div class="font-bold text-lg" id="voltmeter">0.00 V</div><div class="text-sm text-secondary">Voltmeter</div></div>
                                <div><div class="font-bold text-lg" id="ammeter">0.00 A</div><div class="text-sm text-secondary">Ammeter</div></div>
                            </div>
                        </div>
                        <div>
                            <div class="border border-main rounded-lg mb-4"><button class="hint-toggle w-full p-3 font-bold flex justify-between items-center"><span>Procedure & Hints</span><i class="ph-caret-down"></i></button><div class="hint-content"><div class="p-3 border-t border-main text-sm text-secondary"><strong>1. Collect Data:</strong> Move the "Rheostat Control" slider to apply different power levels to the bulb. Click "Record Data" at various points, especially as the bulb starts to glow brightly.<br><strong>2. Calculate Slope:</strong> After collecting at least 2 data points, click "Calculate Slope". This finds the slope of the best-fit line for Log(P) vs Log(T).<br><strong>3. Verify Law:</strong> The calculated slope should be close to 4 to verify Stefan's Law (P ∝ T⁴).</div></div></div>
                            <div class="flex gap-4 mb-4"><button id="stefan-record-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Record Data</button><button id="stefan-calculate-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 disabled:opacity-50" disabled>Calculate Slope</button></div>
                            <div class="h-64 overflow-y-auto border border-main rounded-lg bg-panel mb-4"><table class="w-full text-sm text-left"><thead class="bg-control sticky top-0"><tr class="text-secondary"><th class="p-2">P (W)</th><th class="p-2">T (K)</th><th class="p-2">log₁₀(P)</th><th class="p-2">log₁₀(T)</th></tr></thead><tbody id="stefan-readings"></tbody></table></div>
                            <p class="text-center font-semibold text-lg" id="stefan-result"></p>
                        </div>
                    </div>
                </div>`;
            initFunctions.initStefanslaw = function(view) {
                const rheostat=view.querySelector('#rheostat-slider'),vDisp=view.querySelector('#voltmeter'),aDisp=view.querySelector('#ammeter'),pDisp=view.querySelector('#power-display'),recBtn=view.querySelector('#stefan-record-btn'),calcBtn=view.querySelector('#stefan-calculate-btn'),readingsBody=view.querySelector('#stefan-readings'),resultDisp=view.querySelector('#stefan-result'),bulb=view.querySelector('#stefan-bulb-outline');
                const R0=0.8;
                const tempTable=[[273,1],[373,1.53],[473,2.07],[573,2.63],[673,3.22],[773,3.8],[873,4.4],[973,5],[1073,5.64],[1173,6.37],[1273,6.94],[1373,7.6],[1473,8.26],[1573,8.9],[1673,9.7],[1773,10.43],[2273,14.5],[2773,18.5]];
                let readings=[],V=0,I=0;
                function getTemp(rt_r0){if(rt_r0<=1)return 273;for(let i=0;i<tempTable.length-1;i++){const[T1,R1]=tempTable[i],[T2,R2]=tempTable[i+1];if(rt_r0>=R1&&rt_r0<=R2){return T1+(rt_r0-R1)*((T2-T1)/(R2-R1));}}return 2800;}
                function updateCircuit(){const rheoPercent=parseFloat(rheostat.value)/100;const R_bulb_approx=R0*(1+18*rheoPercent);const R_rheo=100*(1-rheoPercent);const I_total=6/(R_rheo+R_bulb_approx);V=I_total*R_bulb_approx;I=I_total;if(rheoPercent===0){V=0;I=0;}const P=V*I;const T=getTemp((V/I)/R0);vDisp.textContent=`${V.toFixed(2)} V`;aDisp.textContent=`${I.toFixed(2)} A`;pDisp.textContent=`${P.toFixed(2)} W`;const glow=Math.max(0,Math.min(1,(T-800)/1500));bulb.style.fill=`rgba(255, 220, 100, ${glow})`;bulb.style.filter=`blur(${glow*5}px)`;}
                function updateTable(){readingsBody.innerHTML=readings.map(r=>`<tr><td class="p-2 font-mono">${r.P.toFixed(2)}</td><td class="p-2 font-mono">${r.T.toFixed(0)}</td><td class="p-2 font-mono">${r.logP.toFixed(3)}</td><td class="p-2 font-mono">${r.logT.toFixed(3)}</td></tr>`).join('');calcBtn.disabled=readings.length<2;}
                recBtn.addEventListener('click',()=>{if(V<=0||I<=0)return;const P=V*I;const Rt=V/I;const T=getTemp(Rt/R0);if(T<300) return; const logP=Math.log10(P);const logT=Math.log10(T);readings.push({P,T,logP,logT});updateTable();});
                calcBtn.addEventListener('click',()=>{let n=readings.length,sumX=0,sumY=0,sumXY=0,sumX2=0;readings.forEach(r=>{sumX+=r.logT;sumY+=r.logP;sumXY+=r.logT*r.logP;sumX2+=r.logT*r.logT;});const slope=(n*sumXY-sumX*sumY)/(n*sumX2-sumX*sumX);resultDisp.innerHTML=`Calculated Slope (σ): <span class="text-blue-600">${slope.toFixed(3)}</span> (Ideal: 4)`;});
                rheostat.addEventListener('input',updateCircuit); updateCircuit();
            };

             // 5. Carey Foster's Bridge
            templates['carey-foster-bridge'] = `
                <div class="bg-panel text-primary p-6 sm:p-8 rounded-2xl shadow-lg">
                    <header class="flex items-center justify-between pb-4 border-b border-main"><h1 class="text-2xl font-bold">Carey Foster's Bridge</h1><button class="back-to-menu-btn bg-control hover:bg-slate-200 dark:hover:bg-slate-600 text-control font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i class="ph-arrow-left"></i>Back</button></header>
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mt-6">
                        <div class="flex flex-col items-center">
                            <h3 class="font-bold text-secondary mb-2 text-center">Bridge Setup</h3>
                            <div id="bridge-svg" class="w-full"></div>
                            <div class="bridge-container w-full max-w-lg mt-4 relative h-10">
                                <div class="h-2 bg-control rounded-full absolute top-1/2 -translate-y-1/2 w-full border border-main"></div>
                                <div class="absolute top-1/2 -translate-y-1/2 w-full flex justify-between text-xs px-1 text-secondary"><span>0cm</span><span>100cm</span></div>
                                <div id="jockey" class="absolute top-1/2 -translate-y-1/2 w-2 h-10 bg-red-500 rounded cursor-ew-resize" style="left:50%;"><div class="w-4 h-4 rounded-full bg-white border-2 border-red-500 absolute -top-1 -left-1"></div></div>
                            </div>
                             <div id="galvanometer" class="mt-4 w-64 h-24 border-2 border-main rounded-lg flex flex-col items-center justify-center relative p-2 bg-control">
                                <div class="relative w-48 h-12">
                                    <div id="galvo-needle" class="absolute left-1/2 bottom-1 w-1 h-10 bg-red-500 transition-transform origin-bottom" style="transform: rotate(0deg);"></div>
                                    <div class="absolute w-full h-full text-xs text-secondary">
                                        <span class="absolute left-0 bottom-0 transform -rotate-45">-10</span>
                                        <span class="absolute left-1/2 -translate-x-1/2 bottom-0">0</span>
                                        <span class="absolute right-0 bottom-0 transform rotate-45">10</span>
                                    </div>
                                </div>
                                <div id="galvo-reading" class="text-lg font-mono font-bold mt-1 text-primary">0.00 μA</div>
                            </div>
                        </div>
                        <div>
                            <div class="border border-main rounded-lg mb-4"><button class="hint-toggle w-full p-3 font-bold flex justify-between items-center"><span>Procedure & Hints</span><i class="ph-caret-down"></i></button><div class="hint-content"><div class="p-3 border-t border-main text-sm text-secondary"><strong>Part 1 (Find ρ):</strong> Set Mode to "Find ρ". Set a known resistance X. Find the null point (galvanometer at 0) and record l₁. Click "Swap Gaps" and find the new null point l₂. Repeat for different X.<br><strong>Part 2 (Find R):</strong> Set Mode to "Find R". Repeat the process to find l'₁ and l'₂.<br><strong>Calculate:</strong> Use the formulas to find ρ and then R.</div></div></div>
                            <div class="bg-control p-4 rounded-xl border border-main mb-4">
                                <h3 class="font-bold text-primary mb-4">Controls</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium text-secondary">Mode</label><select id="bridge-mode" class="w-full p-2 rounded-md"><option value="rho">Find ρ (Copper Strip)</option><option value="R">Find R (Unknown Wire)</option></select></div>
                                    <div><label class="block text-sm font-medium text-secondary">Known Resistance X (Ω)</label><input id="known-R" type="number" value="1.0" step="0.1" min="0.1" class="w-full p-2 rounded-md"></div>
                                </div>
                                <button id="swap-gaps-btn" class="w-full mt-3 bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Swap Gaps</button>
                            </div>
                            <button id="bridge-record-btn" class="w-full mb-4 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Record Null Point</button>
                            <div class="h-40 overflow-y-auto border border-main rounded-lg bg-panel mb-4"><table class="w-full text-sm text-left"><thead class="bg-control sticky top-0"><tr class="text-secondary"><th class="p-2">X (Ω)</th><th class="p-2">Reading</th><th class="p-2">Value (cm)</th></tr></thead><tbody id="bridge-readings"></tbody></table></div>
                            <p class="text-center font-semibold text-lg" id="bridge-result"></p>
                        </div>
                    </div>
                </div>`;
            initFunctions.initCareyfosterbridge = function(view) {
                const svgContainer=view.querySelector('#bridge-svg'),jockey=view.querySelector('#jockey'),galvoNeedle=view.querySelector('#galvo-needle'),galvoReading=view.querySelector('#galvo-reading'),modeSelect=view.querySelector('#bridge-mode'),knownRIn=view.querySelector('#known-R'),swapBtn=view.querySelector('#swap-gaps-btn'),recordBtn=view.querySelector('#bridge-record-btn'),readingsBody=view.querySelector('#bridge-readings');
                const RHO_ACTUAL=0.015,R_UNKNOWN_ACTUAL=0.7; let isSwapped=false,mode='rho',readings=[];
                function drawSVG(){const X=parseFloat(knownRIn.value).toFixed(1);const Y_text=(mode==='rho'?'Cu Strip':'R wire');const left_text=isSwapped?Y_text:X+' Ω';const right_text=isSwapped?X+' Ω':Y_text;svgContainer.innerHTML=`<svg viewBox="0 0 500 100"><style>.txt{font-size:12px;font-family:monospace;text-anchor:middle;fill:var(--text-primary);}.txt-sec{font-size:10px;fill:var(--text-secondary);}</style><rect x="50" y="30" width="80" height="20" stroke="var(--text-primary)" fill="var(--control-bg)" rx="2"/><text x="90" y="44" class="txt">${left_text}</text><rect x="370" y="30" width="80" height="20" stroke="var(--text-primary)" fill="var(--control-bg)" rx="2"/><text x="410" y="44" class="txt">${right_text}</text><rect x="180" y="30" width="60" height="20" stroke="var(--text-primary)" fill="var(--panel-bg)"/><text x="210" y="44" class="txt">1Ω</text><rect x="260" y="30" width="60" height="20" stroke="var(--text-primary)" fill="var(--panel-bg)"/><text x="290" y="44" class="txt">1Ω</text><path d="M10 40 h 40 M130 40 h 50 M240 40 h 20 M320 40 h 50 M450 40 h 40" stroke="var(--text-primary)" fill="none" stroke-width="2"/><circle cx="155" cy="40" r="3" fill="var(--text-primary)"/><circle cx="345" cy="40" r="3" fill="var(--text-primary)"/><text x="90" y="25" class="txt txt-sec">${isSwapped?'Gap 2':'Gap 1'}</text><text x="410" y="25" class="txt txt-sec">${isSwapped?'Gap 1':'Gap 2'}</text><text x="210" y="25" class="txt txt-sec">P</text><text x="290" y="25" class="txt txt-sec">Q</text></svg>`;}
                function updateBridge(){
                    const X=parseFloat(knownRIn.value),Y=mode==='rho'?0:R_UNKNOWN_ACTUAL,P=1,Q=1;
                    const leftR=isSwapped?Y:X,rightR=isSwapped?X:Y;
                    const l_jockey=parseFloat(jockey.style.left)/100;
                    const R_wire=100*RHO_ACTUAL;
                    const R_left_arm=leftR+l_jockey*R_wire,R_right_arm=rightR+(1-l_jockey)*R_wire;
                    const balance_ratio=(R_left_arm > 0 && R_right_arm > 0) ? (P/Q)/(R_left_arm/R_right_arm) : 1;
                    const deflection=Math.atan(balance_ratio-1)*90;
                    galvoNeedle.style.transform=`rotate(${Math.max(-45,Math.min(45,deflection))}deg)`;
                    const current = deflection / 4.5;
                    if (galvoReading) { galvoReading.textContent = `${current.toFixed(2)} μA`; }
                }
                function moveJockey(x){const rect=jockey.parentElement.getBoundingClientRect();jockey.style.left=`${Math.max(0,Math.min(100, (x/rect.width)*100))}%`;updateBridge();}
                sharedUtils.makeDraggable(jockey, moveJockey, 'x');
                modeSelect.addEventListener('change',()=>{mode=modeSelect.value;readings=[];readingsBody.innerHTML='';isSwapped=false;drawSVG();updateBridge();});
                knownRIn.addEventListener('input',()=>{drawSVG();updateBridge();});
                swapBtn.addEventListener('click',()=>{isSwapped=!isSwapped;drawSVG();updateBridge();});
                recordBtn.addEventListener('click',()=>{const l=parseFloat(jockey.style.left);const X=parseFloat(knownRIn.value);let readingType=mode==='rho'?(isSwapped?'l₂':'l₁'):(isSwapped?"l'₂":"l'₁");readings.push({X,type:readingType,val:l.toFixed(1)});readingsBody.innerHTML+=`<tr><td class="p-2">${X.toFixed(1)}</td><td class="p-2">${readingType}</td><td class="p-2">${l.toFixed(1)}</td></tr>`;});
                drawSVG();updateBridge();
            };

            // 6. Subscription Page
            templates['subscription'] = `
                <div class="bg-panel text-primary p-6 sm:p-8 rounded-2xl shadow-lg">
                    <header class="flex items-center justify-between pb-4 border-b border-main"><h1 class="text-2xl font-bold">Subscription Plans</h1><button class="back-to-menu-btn bg-control hover:bg-slate-200 dark:hover:bg-slate-600 text-control font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i class="ph-arrow-left"></i>Back</button></header>
                    <div class="mt-6 text-center">
                        <p class="text-secondary">Unlock more features and support the development of the Virtual Physics Lab.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8 max-w-4xl mx-auto">
                        <!-- Pro Plan -->
                        <div class="plan-card rounded-xl p-8 flex flex-col">
                            <h3 class="text-2xl font-bold text-cyan-500">Pro</h3>
                            <p class="mt-2 text-secondary">Advanced tools for the serious student.</p>
                            <div class="mt-6">
                                <span class="text-5xl font-bold">₹1000</span>
                                <span class="text-secondary">/ month</span>
                            </div>
                            <ul class="space-y-3 mt-8 text-left flex-grow">
                                <li class="flex items-center gap-3"><i class="ph-fill ph-check-circle text-green-500 text-xl"></i><span>All basic experiments</span></li>
                                <li class="flex items-center gap-3"><i class="ph-fill ph-check-circle text-green-500 text-xl"></i><span>Save and export data</span></li>
                                <li class="flex items-center gap-3"><i class="ph-fill ph-check-circle text-green-500 text-xl"></i><span>Advanced parameter control</span></li>
                                <li class="flex items-center gap-3"><i class="ph-fill ph-check-circle text-green-500 text-xl"></i><span>Access to 5+ more Pro experiments</span></li>
                            </ul>
                            <button class="w-full mt-8 bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-600 transition-colors">Choose Pro</button>
                        </div>
                        <!-- Premium Plan -->
                        <div class="plan-card rounded-xl p-8 flex flex-col border-2 border-amber-400 relative">
                             <div class="absolute top-0 -translate-y-1/2 left-1/2 -translate-x-1/2 bg-amber-400 text-amber-900 text-xs font-bold px-3 py-1 rounded-full">MOST POPULAR</div>
                            <h3 class="text-2xl font-bold text-amber-400">Premium</h3>
                            <p class="mt-2 text-secondary">The complete virtual lab experience for enthusiasts.</p>
                            <div class="mt-6">
                                <span class="text-5xl font-bold">₹2500</span>
                                <span class="text-secondary">/ month</span>
                            </div>
                            <ul class="space-y-3 mt-8 text-left flex-grow">
                                <li class="flex items-center gap-3"><i class="ph-fill ph-check-circle text-green-500 text-xl"></i><span>Everything in Pro</span></li>
                                <li class="flex items-center gap-3"><i class="ph-fill ph-check-circle text-green-500 text-xl"></i><span>Unlimited cloud saves</span></li>
                                <li class="flex items-center gap-3"><i class="ph-fill ph-check-circle text-green-500 text-xl"></i><span>AI-powered lab assistance</span></li>
                                <li class="flex items-center gap-3"><i class="ph-fill ph-check-circle text-green-500 text-xl"></i><span>Priority support</span></li>
                            </ul>
                            <button class="w-full mt-8 bg-amber-400 text-amber-900 font-bold py-3 px-4 rounded-lg hover:bg-amber-500 transition-colors">Choose Premium</button>
                        </div>
                    </div>
                </div>
            `;
            
            App.init();
        });
    </script>
</body>
</html>
